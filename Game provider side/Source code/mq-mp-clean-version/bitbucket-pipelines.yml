definitions:

  services:
    docker:
      memory: 8192

  scripts:

    script_set_env: &script_set_env |
      set -euo pipefail

      case "${TARGET}" in 
        "development_maxduel")
          export ENV_NAME=dev01
          export GCP_PROJECT_ID=${GCP_PROJECT_ID_DEV_MAXDUEL}
          export GCP_PROJECT_NUMBER=${GCP_PROJECT_NUMBER_DEV_MAXDUEL}
          export GCP_REGION=${GCP_REGION_DEV_MAXDUEL}
          export PROJECT_NAME=${PROJECT_NAME_DEV_MAXDUEL}
          export K8S_NAMESPACE=${K8S_NAMESPACE_DEV_MAXDUEL}
          export GCP_USERNAME_PREFIX=${GCP_USERNAME_PREFIX_DEV_MAXDUEL}
          export RUNNER_ID=${RUNNER_ID_DEV_MAXDUEL}
          export SHORT_COMMIT_HASH=${BITBUCKET_COMMIT::7}
          export BUILD_PROFILE=development_maxduel
          export SERVICE_ACCOUNT_KEY=${SERVICE_ACCOUNT_KEY_DEV_MAXDUEL}
          export SERVER_IP_1=${GS1_IP_ADDRESS_DEV_MAXDUEL}
          export SERVER_IP_2=${GS2_IP_ADDRESS_DEV_MAXDUEL}
          export SERVER_IP_3=${GS3_IP_ADDRESS_DEV_MAXDUEL}
          export SERVER_IP_4=${GS4_IP_ADDRESS_DEV_MAXDUEL}
          export SERVER_PORT=22
          export BOTS_SH_SRC_FILE=bots_development_maxduel.sh
          export MQ_GS_GIT_BRANCH=development_maxduel
          ;;
        "pre-prod_maxduel")
          export ENV_NAME=stage01
          export GCP_PROJECT_ID=${GCP_PROJECT_ID_STAGE_MAXDUEL}
          export GCP_PROJECT_NUMBER=${GCP_PROJECT_NUMBER_STAGE_MAXDUEL}
          export GCP_REGION=${GCP_REGION_STAGE_MAXDUEL}
          export PROJECT_NAME=${PROJECT_NAME_STAGE_MAXDUEL}
          export K8S_NAMESPACE=${K8S_NAMESPACE_STAGE_MAXDUEL}
          export GCP_USERNAME_PREFIX=${GCP_USERNAME_PREFIX_STAGE_MAXDUEL}
          export RUNNER_ID=${RUNNER_ID_STAGE_MAXDUEL}
          export SHORT_COMMIT_HASH=${BITBUCKET_COMMIT::7}
          export BUILD_PROFILE=pre-prod_maxduel
          export SERVICE_ACCOUNT_KEY=${SERVICE_ACCOUNT_KEY_STAGE_MAXDUEL}
          export SERVER_IP_1=${GS1_IP_ADDRESS_STAGE_MAXDUEL}
          export SERVER_IP_2=${GS2_IP_ADDRESS_STAGE_MAXDUEL}
          export SERVER_IP_3=${GS3_IP_ADDRESS_STAGE_MAXDUEL}
          export SERVER_IP_4=${GS4_IP_ADDRESS_STAGE_MAXDUEL}
          export SERVER_PORT=22
          export BOTS_SH_SRC_FILE=bots_pre-prod_maxduel.sh
          export MQ_GS_GIT_BRANCH=pre-prod_maxduel
          ;;
        "production_maxduel")
          export ENV_NAME=prod01
          export GCP_PROJECT_ID=${GCP_PROJECT_ID_PROD_MAXDUEL}
          export GCP_PROJECT_NUMBER=${GCP_PROJECT_NUMBER_PROD_MAXDUEL}
          export GCP_REGION=${GCP_REGION_PROD_MAXDUEL}
          export PROJECT_NAME=${PROJECT_NAME_PROD_MAXDUEL}
          export K8S_NAMESPACE=${K8S_NAMESPACE_PROD_MAXDUEL}
          export GCP_USERNAME_PREFIX=${GCP_USERNAME_PREFIX_PROD_MAXDUEL}
          export RUNNER_ID=${RUNNER_ID_PROD_MAXDUEL}
          export SHORT_COMMIT_HASH=${BITBUCKET_COMMIT::7}
          export BUILD_PROFILE=production_maxduel
          export SERVICE_ACCOUNT_KEY=${SERVICE_ACCOUNT_KEY_PROD_MAXDUEL}
          export SERVER_IP_1=${GS1_IP_ADDRESS_PROD_MAXDUEL}
          export SERVER_IP_2=${GS2_IP_ADDRESS_PROD_MAXDUEL}
          export SERVER_IP_3=${GS3_IP_ADDRESS_PROD_MAXDUEL}
          export SERVER_IP_4=${GS4_IP_ADDRESS_PROD_MAXDUEL}
          export SERVER_PORT=22
          export BOTS_SH_SRC_FILE=bots_production_maxduel.sh
          export MQ_GS_GIT_BRANCH=production_maxduel
          ;;
        "test_maxquest")
          export ENV_NAME=dev01
          export GCP_PROJECT_ID=${GCP_PROJECT_ID_DEV}
          export GCP_PROJECT_NUMBER=${GCP_PROJECT_NUMBER_DEV}
          export GCP_REGION=${GCP_REGION_DEV}
          export PROJECT_NAME=${PROJECT_NAME_DEV}
          export K8S_NAMESPACE=${K8S_NAMESPACE_DEV}
          export RUNNER_ID=${RUNNER_ID_DEV}
          export SHORT_COMMIT_HASH=${BITBUCKET_COMMIT::7}
          export BUILD_PROFILE=mqb-test
          export SERVER_IP_1=${GS1_TEST_ADDRESS}
          export SERVER_IP_2=${GS2_TEST_ADDRESS}
          export SERVER_IP_3=${GS3_TEST_ADDRESS}
          export SERVER_PORT=222
          ;;
        "pre-prod_maxquest")
          export ENV_NAME=stage01
          export GCP_PROJECT_ID=${GCP_PROJECT_ID_STAGE}
          export GCP_PROJECT_NUMBER=${GCP_PROJECT_NUMBER_STAGE}
          export GCP_REGION=${GCP_REGION_STAGE}
          export PROJECT_NAME=${PROJECT_NAME_STAGE}
          export K8S_NAMESPACE=${K8S_NAMESPACE_STAGE}
          export RUNNER_ID=${RUNNER_ID_STAGE}
          export SHORT_COMMIT_HASH=${BITBUCKET_COMMIT::7}
          export BUILD_PROFILE=mqb-pre-prod
          export SERVER_IP_1=${GS1_PRE_PROD_ADDRESS}
          export SERVER_IP_2=${GS2_PRE_PROD_ADDRESS}
          export SERVER_IP_3=${GS3_PRE_PROD_ADDRESS}
          export SERVER_PORT=222
          ;;
        "production_maxquest")
          export ENV_NAME=prod01
          export GCP_PROJECT_ID=${GCP_PROJECT_ID_PROD}
          export GCP_PROJECT_NUMBER=${GCP_PROJECT_NUMBER_PROD}
          export GCP_REGION=${GCP_REGION_PROD}
          export PROJECT_NAME=${PROJECT_NAME_PROD}
          export K8S_NAMESPACE=${K8S_NAMESPACE_PROD}
          export RUNNER_ID=${RUNNER_ID_PROD}
          export SHORT_COMMIT_HASH=${BITBUCKET_COMMIT::7}
          export BUILD_PROFILE=mqb-prod
          export SERVER_IP_1=${GS1_PROD_ADDRESS}
          export SERVER_IP_2=${GS2_PROD_ADDRESS}
          export SERVER_IP_3=${GS3_PROD_ADDRESS}
          export SERVER_IP_4=${GS4_PROD_ADDRESS}
          export SERVER_PORT=22
          ;;
        *)
          echo "ERROR: INCORRECT BITBUCKET_BRANCH/TAG ${1} FOR DEPLOY"
          exit 1
          ;;
      esac

      env | sort

    script_export_ssh_key: &script_export_ssh_key |
      echo ${SSH_PRIVATE_KEY} | base64 -d > /tmp/${RUNNER_ID}/ssh/id_rsa
      echo "StrictHostKeyChecking no" >> ~/.ssh/config

    script_gcp_auth: &script_gcp_auth |
      mkdir ${PWD}/.GCP_CREDS
      export GCP_CREDS=${PWD}/.GCP_CREDS
      echo ${BITBUCKET_STEP_OIDC_TOKEN} > ${GCP_CREDS}/gcp_access_token.out
      export GCP_WORKLOAD_IDENTITY_PROVIDER="projects/${GCP_PROJECT_NUMBER}/locations/global/workloadIdentityPools/${PROJECT_NAME}-${ENV_NAME}-${GCP_USERNAME_PREFIX}/providers/${PROJECT_NAME}-${ENV_NAME}-${GCP_USERNAME_PREFIX}"
      export GCP_SERVICE_ACCOUNT_EMAIL="${PROJECT_NAME}-${ENV_NAME}-${GCP_USERNAME_PREFIX}@${GCP_PROJECT_ID}.iam.gserviceaccount.com"
      gcloud iam workload-identity-pools create-cred-config ${GCP_WORKLOAD_IDENTITY_PROVIDER} \
        --service-account="${GCP_SERVICE_ACCOUNT_EMAIL}" \
        --output-file=${GCP_CREDS}/gcp_temp_cred.json \
        --credential-source-file=${GCP_CREDS}/gcp_access_token.out
      gcloud auth login --cred-file=${GCP_CREDS}/gcp_temp_cred.json
      gcloud config set project ${GCP_PROJECT_ID}
      gcloud auth list
      gcloud auth configure-docker ${GCP_REGION}-docker.pkg.dev

    script_install_packages: &script_install_packages |
      apt install -y --no-install-recommends gettext-base

    script_git_download_dependencies: &script_git_download_dependencies |
      git clone --depth 1 ${ADDITIONAL_REPOSITORY}

    script_git_download_dependencies_preprod: &script_git_download_dependencies_preprod |
      git clone --branch ${MQ_GS_GIT_TAG_PREPROD} --depth 1 ${ADDITIONAL_REPOSITORY}

    script_git_download_dependencies_maxduel_dev01: &script_git_download_dependencies_maxduel_dev01 |
      git clone --branch ${MQ_GS_GIT_BRANCH} --depth 1 ${ADDITIONAL_REPOSITORY}

    script_git_download_dependencies_maxduel_stage01: &script_git_download_dependencies_maxduel_stage01 |
      git clone --branch ${MQ_GS_GIT_BRANCH} --depth 1 ${ADDITIONAL_REPOSITORY}

    script_git_download_dependencies_maxduel_prod01: &script_git_download_dependencies_maxduel_prod01 |
      git clone --branch ${MQ_GS_GIT_BRANCH} --depth 1 ${ADDITIONAL_REPOSITORY}

    script_chmod: &script_chmod |
      find . -type d -exec chmod 0755 {} \;
      find . -type f -exec chmod 0644 {} \;

      chmod -v +x mq-gs/build-all-modules.sh
      chmod -v +x mq-gs/install-gsn-casino-project.sh
      chmod -v +x deploy.sh
      chmod -v +x deploy_prod.sh
      chmod -v +x bots/bots_*.sh

    script_docker_build_step_1: &script_docker_build_step_1 |
      export PATH=/usr/bin:$PATH
      export GCS_BUCKET=md-${ENV_NAME}-tools

      cat Dockerfile.build.step_1.tpl | envsubst > Dockerfile.build.step_1
      cat Dockerfile.build.step_1

      export IMAGE=${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${PROJECT_NAME}-${ENV_NAME}/${APP_NAME}-new
      export TAG=step_1_${SHORT_COMMIT_HASH}
      export DOCKERFILE=Dockerfile.build.step_1
      
      docker build -t ${IMAGE}:${TAG} -f ${DOCKERFILE} . --progress=plain

      docker images

      docker push ${IMAGE}:${TAG}

    script_docker_build_step_2: &script_docker_build_step_2 |
      export PATH=/usr/bin:$PATH
      export GCS_BUCKET=md-${ENV_NAME}-tools

      cat Dockerfile.build.step_2.tpl | envsubst > Dockerfile.build.step_2
      cat Dockerfile.build.step_2

      export IMAGE=${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${PROJECT_NAME}-${ENV_NAME}/${APP_NAME}-new
      export TAG=step_2_${SHORT_COMMIT_HASH}
      export DOCKERFILE=Dockerfile.build.step_2

      export DOCKER_BUILDKIT=1
      export BUILDKIT_PROGRESS=plain

      docker pull ${IMAGE}:step_1_${SHORT_COMMIT_HASH}

      docker build -t ${IMAGE}:${TAG} -f ${DOCKERFILE} . --progress=plain

      docker images

      docker tag ${IMAGE}:${TAG} ${IMAGE}:latest

      docker push ${IMAGE}:${TAG}
      docker push ${IMAGE}:latest

    script_docker_build_step_bs: &script_docker_build_step_bs |
      export PATH=/usr/bin:$PATH
      export GCS_BUCKET=md-${ENV_NAME}-tools

      cat Dockerfile.build.step_bs.tpl | envsubst > Dockerfile.build.step_bs
      cat Dockerfile.build.step_bs

      export IMAGE=${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${PROJECT_NAME}-${ENV_NAME}/${APP_NAME_BOTS}-new
      export TAG=step_bs_${SHORT_COMMIT_HASH}
      export DOCKERFILE=Dockerfile.build.step_bs

      export DOCKER_BUILDKIT=1
      export BUILDKIT_PROGRESS=plain

      docker build -t ${IMAGE}:${TAG} -f ${DOCKERFILE} . --progress=plain

      docker images

      docker tag ${IMAGE}:${TAG} ${IMAGE}:latest

      docker push ${IMAGE}:${TAG}
      docker push ${IMAGE}:latest

    script_extract_build_artifacts: &script_extract_build_artifacts |
      mkdir -vp artifacts/bots

      docker create --name temp-container ${IMAGE}:${TAG}

      docker cp temp-container:/app/web/target/web-mp-casino.war            artifacts/
      docker cp temp-container:/app/bots/target/mp-bots-1.0.0-SNAPSHOT.jar  artifacts/bots
      docker cp temp-container:/app/bots/target/lib                         artifacts/bots

      docker rm temp-container

      ls -alhR artifacts/

    script_deploy_legacy: &script_deploy_legacy |
      scp    -P ${SERVER_PORT} artifacts/bots/mp-bots-1.0.0-SNAPSHOT.jar  bitbucket@${SERVER_IP_4}:/www/html/mp/bots
      scp -r -P ${SERVER_PORT} artifacts/bots/lib                         bitbucket@${SERVER_IP_4}:/www/html/mp/bots
      scp    -P ${SERVER_PORT} bots/bots.sh                               bitbucket@${SERVER_IP_4}:/www/html/mp/bots
      scp    -P ${SERVER_PORT} bots/bots_restart_scheduler.sh             bitbucket@${SERVER_IP_4}:/www/html/mp/bots

      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_4} "sudo /www/html/mp/bots/bots.sh restart"

      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_1}:/www/html/mp
      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_2}:/www/html/mp
      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_3}:/www/html/mp

      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_1}:/www/html/mp
      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_2}:/www/html/mp
      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_3}:/www/html/mp

      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_1} "sudo /www/html/mp/deploy.sh"
      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_2} "sudo /www/html/mp/deploy.sh"
      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_3} "sudo /www/html/mp/deploy.sh"

    script_deploy_legacy_maxduel: &script_deploy_legacy_maxduel |
      INSTANCE_LIST=$(gcloud compute instances list --filter="name~'^${PROJECT_NAME}-${ENV_NAME}-legacy-mp-'" --format="csv[no-heading](name,zone)") || {
        echo "Failed to list instances"
        exit 1
      }
      echo "----------------------------------------"
      echo 'TARGET INSTANCES FOR DEPLOY:'
      IFS=$'\n'
      for line in ${INSTANCE_LIST}; do
        echo ${line}
      done
      echo "----------------------------------------"
      IFS=$'\n'
      for line in ${INSTANCE_LIST}; do
        INSTANCE_NAME=$(echo ${line} | cut -d',' -f1)
        INSTANCE_ZONE=$(echo ${line} | cut -d',' -f2)
        echo "Connecting to ${INSTANCE_NAME} in zone ${INSTANCE_ZONE}..."
        gcloud compute ssh --project "${GCP_PROJECT_ID}" --zone="${INSTANCE_ZONE}" --internal-ip "${INSTANCE_NAME}" --ssh-flag="-o ServerAliveInterval=30" --ssh-flag="-o ServerAliveCountMax=10" --command="\
          echo '----------------------------------------' && \
          echo 'STATE BEFORE DEPLOY ON ${INSTANCE_NAME}:' && \
          echo '----------------------------------------' && \
          docker images && \
          echo '----------------------------------------' && \
          docker ps -a && \
          echo '----------------------------------------' && \
          df -h / && \
          echo '----------------------------------------' && \
          uptime && \
          echo '----------------------------------------' && \
          echo '----------------------------------------' && \
          echo '----------------------------------------' && \
          cd /opt/${APP_NAME} && \
          docker compose pull && \
          echo '----------------------------------------' && \
          docker compose up -d && \
          docker image prune -a -f && \
          echo '----------------------------------------' && \
          echo 'STATE AFTER DEPLOY ON ${INSTANCE_NAME}:' && \
          echo '----------------------------------------' && \
          docker images && \
          echo '----------------------------------------' && \
          docker ps -a && \
          echo '----------------------------------------' && \
          df -h / && \
          echo '----------------------------------------' && \
          uptime && \
          echo '----------------------------------------'" || {
          echo "Failed to execute commands on ${INSTANCE_NAME}"
          exit 1
        }
        echo "Command execution on ${INSTANCE_NAME} completed."
        echo '----------------------------------------'
        echo '----------------------------------------'
      done

    script_deploy_legacy_maxduel_bs: &script_deploy_legacy_maxduel_bs |
      INSTANCE_LIST=$(gcloud compute instances list --filter="name~'^${PROJECT_NAME}-${ENV_NAME}-legacy-bs-'" --format="csv[no-heading](name,zone)") || {
        echo "Failed to list instances"
        exit 1
      }
      echo "----------------------------------------"
      echo 'TARGET INSTANCES FOR DEPLOY:'
      IFS=$'\n'
      for line in ${INSTANCE_LIST}; do
        echo ${line}
      done
      echo "----------------------------------------"
      IFS=$'\n'
      for line in ${INSTANCE_LIST}; do
        INSTANCE_NAME=$(echo ${line} | cut -d',' -f1)
        INSTANCE_ZONE=$(echo ${line} | cut -d',' -f2)
        echo "Connecting to ${INSTANCE_NAME} in zone ${INSTANCE_ZONE}..."
        gcloud compute ssh --project "${GCP_PROJECT_ID}" --zone="${INSTANCE_ZONE}" --internal-ip "${INSTANCE_NAME}" --ssh-flag="-o ServerAliveInterval=30" --ssh-flag="-o ServerAliveCountMax=10" --command="\
          echo '----------------------------------------' && \
          echo 'STATE BEFORE DEPLOY ON ${INSTANCE_NAME}:' && \
          echo '----------------------------------------' && \
          docker images && \
          echo '----------------------------------------' && \
          docker ps -a && \
          echo '----------------------------------------' && \
          df -h / && \
          echo '----------------------------------------' && \
          uptime && \
          echo '----------------------------------------' && \
          echo '----------------------------------------' && \
          echo '----------------------------------------' && \
          cd /opt/${APP_NAME_BOTS} && \
          docker compose pull && \
          echo '----------------------------------------' && \
          docker compose up -d && \
          docker image prune -a -f && \
          echo '----------------------------------------' && \
          echo 'STATE AFTER DEPLOY ON ${INSTANCE_NAME}:' && \
          echo '----------------------------------------' && \
          docker images && \
          echo '----------------------------------------' && \
          docker ps -a && \
          echo '----------------------------------------' && \
          df -h / && \
          echo '----------------------------------------' && \
          uptime && \
          echo '----------------------------------------'" || {
          echo "Failed to execute commands on ${INSTANCE_NAME}"
          exit 1
        }
        echo "Command execution on ${INSTANCE_NAME} completed."
        echo '----------------------------------------'
        echo '----------------------------------------'
      done

    script_deploy_legacy_test: &script_deploy_legacy_test |
      cp -v bots/bots_test.sh bots/bots.sh
      chmod -v +x bots/bots.sh
      chmod -v +x deploy.sh

      scp    -P ${SERVER_PORT} artifacts/bots/mp-bots-1.0.0-SNAPSHOT.jar  bitbucket@${SERVER_IP_1}:/www/html/mp/bots
      scp -r -P ${SERVER_PORT} artifacts/bots/lib                         bitbucket@${SERVER_IP_1}:/www/html/mp/bots
      scp    -P ${SERVER_PORT} bots/bots.sh                               bitbucket@${SERVER_IP_1}:/www/html/mp/bots

      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_1} "sudo /www/html/mp/bots/bots.sh restart"

      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_1}:/www/html/mp
      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_2}:/www/html/mp
      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_3}:/www/html/mp

      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_1}:/www/html/mp
      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_2}:/www/html/mp
      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_3}:/www/html/mp

      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_1} "sudo /www/html/mp/deploy.sh"
      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_2} "sudo /www/html/mp/deploy.sh"
      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_3} "sudo /www/html/mp/deploy.sh"

    script_deploy_legacy_preprod: &script_deploy_legacy_preprod |
      cp -v bots/bots_test.sh bots/bots.sh
      chmod -v +x bots/bots.sh
      chmod -v +x deploy.sh

      scp    -P ${SERVER_PORT} artifacts/bots/mp-bots-1.0.0-SNAPSHOT.jar  bitbucket@${SERVER_IP_1}:/www/html/mp/bots
      scp -r -P ${SERVER_PORT} artifacts/bots/lib                         bitbucket@${SERVER_IP_1}:/www/html/mp/bots
      scp    -P ${SERVER_PORT} bots/bots.sh                               bitbucket@${SERVER_IP_1}:/www/html/mp/bots

      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_1} "sudo /www/html/mp/bots/bots.sh restart"

      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_1}:/www/html/mp
      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_2}:/www/html/mp
      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_3}:/www/html/mp

      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_1}:/www/html/mp
      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_2}:/www/html/mp
      scp    -P ${SERVER_PORT} deploy.sh                                  bitbucket@${SERVER_IP_3}:/www/html/mp

      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_1} "sudo /www/html/mp/deploy.sh"
      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_2} "sudo /www/html/mp/deploy.sh"
      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_3} "sudo /www/html/mp/deploy.sh"

    script_deploy_legacy_production: &script_deploy_legacy_production |
      cp -v bots/bots_prod.sh bots/bots.sh
      chmod -v +x bots/bots.sh
      chmod -v +x deploy.sh

      scp    -P ${SERVER_PORT} artifacts/bots/mp-bots-1.0.0-SNAPSHOT.jar  bitbucket@${SERVER_IP_4}:/www/html/mp/bots
      scp -r -P ${SERVER_PORT} artifacts/bots/lib                         bitbucket@${SERVER_IP_4}:/www/html/mp/bots
      scp    -P ${SERVER_PORT} bots/bots.sh                               bitbucket@${SERVER_IP_4}:/www/html/mp/bots

      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_4} "sudo /www/html/mp/bots/bots.sh restart"

      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_1}:/www/html/mp
      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_2}:/www/html/mp
      scp    -P ${SERVER_PORT} artifacts/web-mp-casino.war                bitbucket@${SERVER_IP_3}:/www/html/mp

      scp    -P ${SERVER_PORT} deploy_prod.sh                             bitbucket@${SERVER_IP_1}:/www/html/mp
      scp    -P ${SERVER_PORT} deploy_prod.sh                             bitbucket@${SERVER_IP_2}:/www/html/mp
      scp    -P ${SERVER_PORT} deploy_prod.sh                             bitbucket@${SERVER_IP_3}:/www/html/mp

      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_1} "sudo /www/html/mp/deploy_prod.sh deploy"
      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_2} "sudo /www/html/mp/deploy_prod.sh deploy"
      ssh    -p ${SERVER_PORT}                                            bitbucket@${SERVER_IP_3} "sudo /www/html/mp/deploy_prod.sh deploy"

    script_cleanup: &script_cleanup |
      rm -rf .* *
      ls -alhR

    step_deploy_legacy_maxduel_dev01_step_1: &step_deploy_legacy_maxduel_dev01_step_1
      name: step_deploy_legacy_maxduel_dev01_step_1
      runs-on:
        - self.hosted
        - linux
        - md.dev01.legacy
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=development_maxduel
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_git_download_dependencies_maxduel_dev01
        - *script_chmod
        - *script_docker_build_step_1
      after-script:
        - *script_cleanup

    step_deploy_legacy_maxduel_dev01_step_2: &step_deploy_legacy_maxduel_dev01_step_2
      name: step_deploy_legacy_maxduel_dev01_step_2
      runs-on:
        - self.hosted
        - linux
        - md.dev01.legacy
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=development_maxduel
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_docker_build_step_2
        - *script_docker_build_step_bs
        - *script_deploy_legacy_maxduel_bs
        - *script_deploy_legacy_maxduel
      after-script:
        - *script_cleanup
      trigger: manual

    step_deploy_legacy_maxduel_stage01_step_1: &step_deploy_legacy_maxduel_stage01_step_1
      name: step_deploy_legacy_maxduel_stage01_step_1
      runs-on:
        - self.hosted
        - linux
        - md.stage01.legacy
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=pre-prod_maxduel
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_git_download_dependencies_maxduel_stage01
        - *script_chmod
        - *script_docker_build_step_1
      after-script:
        - *script_cleanup

    step_deploy_legacy_maxduel_stage01_step_2: &step_deploy_legacy_maxduel_stage01_step_2
      name: step_deploy_legacy_maxduel_stage01_step_2
      runs-on:
        - self.hosted
        - linux
        - md.stage01.legacy
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=pre-prod_maxduel
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_docker_build_step_2
        - *script_docker_build_step_bs
        - *script_deploy_legacy_maxduel_bs
        - *script_deploy_legacy_maxduel
      after-script:
        - *script_cleanup
      trigger: manual

    step_deploy_legacy_maxduel_prod01_step_1: &step_deploy_legacy_maxduel_prod01_step_1
      name: step_deploy_legacy_maxduel_prod01_step_1
      runs-on:
        - self.hosted
        - linux
        - md.prod01.legacy
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=production_maxduel
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_git_download_dependencies_maxduel_prod01
        - *script_chmod
        - *script_docker_build_step_1
      after-script:
        - *script_cleanup

    step_deploy_legacy_maxduel_prod01_step_2: &step_deploy_legacy_maxduel_prod01_step_2
      name: step_deploy_legacy_maxduel_prod01_step_2
      runs-on:
        - self.hosted
        - linux
        - md.prod01.legacy
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=production_maxduel
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_docker_build_step_2
        - *script_docker_build_step_bs
        - *script_deploy_legacy_maxduel_bs
        - *script_deploy_legacy_maxduel
      after-script:
        - *script_cleanup
      trigger: manual

    step_deploy_legacy_test_step_1: &step_deploy_legacy_test_step_1
      name: step_deploy_legacy_test_step_1
      runs-on:
        - self.hosted
        - linux
        - mq.dev01
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=test_maxquest
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_git_download_dependencies
        - *script_chmod
        - *script_docker_build_step_1
      after-script:
        - *script_cleanup

    step_deploy_legacy_test_step_2: &step_deploy_legacy_test_step_2
      name: step_deploy_legacy_test_step_2
      runs-on:
        - self.hosted
        - linux
        - mq.dev01
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=test_maxquest
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_docker_build_step_2
        - *script_extract_build_artifacts
        - *script_deploy_legacy_test
      after-script:
        - *script_cleanup
      trigger: manual

    step_deploy_legacy_pre-prod_step_1: &step_deploy_legacy_pre-prod_step_1
      name: step_deploy_legacy_pre-prod_step_1
      runs-on:
        - self.hosted
        - linux
        - mq.stage01
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=pre-prod_maxquest
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_git_download_dependencies_preprod
        - *script_chmod
        - *script_docker_build_step_1
      after-script:
        - *script_cleanup

    step_deploy_legacy_pre-prod_step_2: &step_deploy_legacy_pre-prod_step_2
      name: step_deploy_legacy_pre-prod_step_2
      runs-on:
        - self.hosted
        - linux
        - mq.stage01
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=pre-prod_maxquest
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_docker_build_step_2
        - *script_extract_build_artifacts
        - *script_deploy_legacy_preprod
      after-script:
        - *script_cleanup
      trigger: manual

    step_deploy_legacy_prod_step_1: &step_deploy_legacy_prod_step_1
      name: step_deploy_legacy_prod_step_1
      runs-on:
        - self.hosted
        - linux
        - mq.prod01
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=production_maxquest
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_git_download_dependencies
        - *script_chmod
        - *script_docker_build_step_1
      after-script:
        - *script_cleanup

    step_deploy_legacy_prod_step_2: &step_deploy_legacy_prod_step_2
      name: step_deploy_legacy_prod_step_2
      runs-on:
        - self.hosted
        - linux
        - mq.prod01
      image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest
      oidc: true
      clone:
        enabled: true
        depth: 2
      services:
        - docker
      size: 4x
      script:
        - export TARGET=production_maxquest
        - *script_set_env
        - *script_export_ssh_key
        - *script_gcp_auth
        - *script_install_packages
        - *script_docker_build_step_2
        - *script_extract_build_artifacts
        - *script_deploy_legacy_production
      after-script:
        - *script_cleanup
      trigger: manual

pipelines:
  branches:
    development_maxduel:
      - step: *step_deploy_legacy_maxduel_dev01_step_1
      - step: *step_deploy_legacy_maxduel_dev01_step_2

    pre-prod_maxduel:
      - step: *step_deploy_legacy_maxduel_stage01_step_1
      - step: *step_deploy_legacy_maxduel_stage01_step_2

    production_maxduel:
      - step: *step_deploy_legacy_maxduel_prod01_step_1
      - step: *step_deploy_legacy_maxduel_prod01_step_2

  tags:
    'mp-test.*':
      - step: *step_deploy_legacy_test_step_1
      - step: *step_deploy_legacy_test_step_2

    'mp-pre-prod.*':
      - step: *step_deploy_legacy_pre-prod_step_1
      - step: *step_deploy_legacy_pre-prod_step_2

    'mp-prod.*':
      - step: *step_deploy_legacy_prod_step_1
      - step: *step_deploy_legacy_prod_step_2

