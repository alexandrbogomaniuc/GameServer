= MaxQuest Tournament Lobby
Betsoft Gaming
v3.0
:source-highlighter: coderay

== 1. Lobby Protocol
This document describes communication between MaxQuest Tournament Lobby and Game Server. +
When tournament Lobby loaded, it should establish websocket connection with Game Server and use this protocol for communication.

=== 1.1 EnterLobby
[source,json]
{
  "sid": "4_eb0bf169cbb477b6f8430000015cbe83_fwRFDR4FWFZTV142PiQUCQ4H",
  "date": 1496750162302,
  "class": "EnterLobby",
  "rid": 1,
  "lang": "en"
}

[source,json]
{
  "class": "EnterLobbyResponse",
  "networkTournament": {
      "id": 100,
      "title": "Big network tournament",
      "events": [101, 102],
      "tournamentRules": "Minimum shot requirement: A player must take a minimum of 1 shot to qualify ...",
      "prizeAllocation": "Prizes are paid out to players as a fixed amount according to ...",
      "howToWin": "Players with the highest score on the top 100 positions of ...",
      "startDate": 1496750162302,
      "endDate": 1506750162302,
      "buyInPrice": 0,
      "buyInAmount": 0,
      "reBuyPrice": 0,
      "reBuyAmount": 0,
      "reBuyAllowed": false,
      "reBuyLimit": 0,
      "prizePool": 250000,
      "joined": false,
      "state": "STARTED",
      "icon": "",
      "games": [808, 821]
  }
  "tournaments": [
    {
      "id": 101,
      "networkTournamentId": 100,
      "title": "Event 1",
      "startDate": 1496750162302,
      "endDate": 1506750162302,
      "buyInPrice": 0,
      "buyInAmount": 1000,
      "reBuyPrice": 50,
      "reBuyAmount": 500,
      "reBuyAllowed": true,
      "reBuyLimit": 200,
      "prizePool": 250000,
      "joined": false,
      "state": "STARTED",
      "icon": "https://betsoft.com/tournaments/icon1.png",
      "games": [808, 821]
    },
    {
      "id": 102,
      "networkTournamentId": 100,
      "title": "Event 2",
      "startDate": 1496750162302,
      "endDate": 1506750162302,
      "buyInPrice": 0,
      "buyInAmount": 1000,
      "reBuyPrice": 50,
      "reBuyAmount": 500,
      "reBuyAllowed": true,
      "reBuyLimit": 200,
      "prizePool": 250000,
      "joined": false,
      "state": "READY",
      "icon": "https://betsoft.com/tournaments/icon1.png",
      "games": [808, 821]
    },
    {
      "id": 1001,
      "title": "Captain Brutus's party",
      "startDate": 1496750162302,
      "endDate": 1506750162302,
      "buyInPrice": 100,
      "buyInAmount": 1000,
      "reBuyPrice": 50,
      "reBuyAmount": 500,
      "reBuyAllowed": true,
      "reBuyLimit": 200,
      "prizePool": 250000,
      "joined": true,
      "state": "FINISHED",
      "icon": "https://betsoft.com/tournaments/icon1.png",
      "games": [808]
    },
    {
      "id": 1002,
      "title": "Amazonian Journey",
      "startDate": 1496750162302,
      "endDate": 1506750162302,
      "buyInPrice": 0
      "buyInAmount": 1000,
      "reBuyPrice": 0,
      "reBuyAmount": 500,
      "reBuyAllowed": false,
      "reBuyLimit": -1,
      "prizePool": 2500,
      "joined": false,
      "state": "STARTED",
      "icon": "https://betsoft.com/tournaments/icon1.png",
      "games": [821]
    },
  ],
  "balance": 12345,
  "currencySymbol": "$",
  "currencyCode": "USD"
  "battlegrounds":[
     {
        "gameId": 821,
        "icon": "https://betsoft.com/battleground/821.png",
        "rules": "https://betsoft.com/battleground/821-rules.html",
        "buyIns": [100, 200, 500, 1000, 2000, 5000]
     },
     {
        "gameId": 808,
        "icon": "https://betsoft.com/battleground/808.png",
        "rules": "https://betsoft.com/battleground/808-rules.html",
        "buyIns": [50, 100, 1000, 5000, 10000]
     }
  ]
}

networkTournament:: network tournament. Fileds buyInPrice, buyInAmount, reBuyPrice, reBuyAmount, reBuyAllowed,
reBuyLimit, icon for network tournament always zero or empty.
networkTournament:events:: list related tournament events (sub-tournaments)
networkTournament:tournamentRules:: network tournament rules
networkTournament:prizeAllocation:: info about prize allocation
networkTournament:howToWin:: how to win rules
tournaments:: list of visible tournaments
tournaments:id:: tournament id
tournaments:networkTournamentId:: empty for regular tournaments, for tournament events this is network tournament id
tournaments:title:: tournament title
tournaments:startDate:: tournament start date
tournaments:endDate:: tournament end date
tournaments:buyInPrice:: tournament participation cost, 0 for free-roll tournaments
tournaments:buyInAmount:: initial tournament balance
tournaments:reBuyPrice:: price to purchase additional bullets, 0 for free-roll tournaments
tournaments:reBuyAmount:: amount of money added to tournament balance after reBuy
tournaments:reBuyAllowed:: true if tournament allows re-buys
tournaments:reBuyLimit:: rebuys count limited, -1 for no limit
tournaments:prizePool:: total tournament's prize pool
tournaments:joined:: true if player already joined this tournament
tournaments:state:: current tournament's state, possible values - READY, STARTED, FINISHED, CANCELLED
tournaments:games:: ids of games which could be used to participate in this tournament
balance:: current player's real balance
currencySymbol:: symbol of player's balance currency
currencyCode:: code of player's balance currency
battlegrounds:: list of available battlegrounds
battlegrounds::gameId:: battleground game id
battlegrounds::icon:: icon for battleground
battlegrounds::rules:: link to battleground game rules
battlegrounds::buyIns:: available buyin amounts in cents

=== 1.2 GetTournamentDetails
[source,json]
{
  "class": "GetTournamentDetails",
  "rid": 1,
  "date": 1496750162302,
  "tournamentId": 123
}

[source,json]
{
  "class": "TournamentDetails",
  "rid": 1,
  "date": 1496750162302,
  "tournamentId": 123,
  "title": "Captain Brutus's party",
  "description": "Captain Brutus invites you to join his party and gives a lot of presents",
  "startDate": 1496750162302,
  "endDate": 1506750162302,
  "buyInPrice": 0,
  "buyInAmount": 1000,
  "reBuyPrice": 0,
  "reBuyAmount": 500,
  "reBuyAllowed": false,
  "reBuyLimit": 200,
  "prizePool": 250000,
  "games": [808]
  "state": "STARTED"
  "prizes": [
    { "place": 1, "prize": 100000 },
    { "place": 2, "prize": 50000 },
    { "place": 3, "prize": 25000 },
    { "place": 4, "prize": 25000 },
    { "place": 5, "prize": 25000 },
    { "place": 6, "prize": 5000 },
    { "place": 7, "prize": 5000 },
    { "place": 8, "prize": 5000 },
    { "place": 9, "prize": 5000 },
    { "place": 10, "prize": 5000 }
  ]
}

=== 1.3 TournamentStateChanged
[source,json]
{
  "class": "TournamentStateChanged",
  "date": 1496750162302,
  "rid": -1,
  "tournamentId": 123,
  "state": "CANCELLED"
}

=== 1.4 NewTournament
[source,json]
{
  "class": "NewTournament",
  "date": 1496750162302,
  "rid": -1,
  "tournament": {
    "id": 1002,
    "title": "Amazonian Journey",
    "startDate": 1496750162302,
    "endDate": 1506750162302,
    "buyInPrice": 100,
    "buyInAmount": 1000,
    "reBuyPrice": 50,
    "reBuyAmount": 500,
    "reBuyAllowed": false,
    "reBuyLimit": 200,
    "prizePool": 2500,
    "joined": false,
    "state": "STARTED",
    "icon": "https://betsoft.com/tournaments/icon1.png",
    "games": [821]
  }
}

=== 1.5 JoinTournament
[source,json]
{
  "class": "JoinTournament",
  "tournamentId": 123,
  "gameId": 808,
  "date": 1496750162302,
  "rid": 1,
  "playerAlias": "Mike"
}

gameId:: selected gameId
playerAlias:: player nickName for network tournaments. Ignored for regular tournaments

[source,json]
{
  "class": "JoinTournamentResponse",
  "tournamentId": 123,
  "gameId": 808,
  "balance": 1000,
  "rid": 1,
  "link": "https://betsoft.com/launch.jsp?...",
  "renamed": true,
  "assignedPlayerAlis": "Mike#4"
}

renamed:: only for network tournaments flag. If true, entered nickName already taken and server
assign alternate nickName.
assignedPlayerAlis:: only for network tournaments flag. Assigned nickName.

[source,json]
{
  "class": "Error",
  "date": 1496750162302,
  "rid": -1,
  "code": 1002,
  "message": "Insufficient Funds"
}

=== 1.6 GetLeaderboard
[source,json]
{
  "class": "GetLeaderboard",
  "date": 1496750162302,
  "rid": 1,
  "tournamentId": 123
}

[source,json]
{
  "class": "Leaderboard",
  "date": 1496750162302,
  "rid": 1,
  "tournamentId": 123,
  "endDate": 150000000000,
  "state": "STARTED",
  "prizePlaces": 10,
  "leaderboard": [
    { "place": 1, "name": "Mad Max", "score": 26550, "prize": 100000 },
    { "place": 2, "name": "Punisher 444", "score": 18960 },
    { "place": 3, "name": "Blue1988", "score": 17990 },
    { "place": 4, "name": "Big Daddy", "score": 15002 },
    { "place": 5, "name": "Sebastian F", "score": 14440 },
    { "place": 6, "name": "Eddy Brock 123", "score": 13500 },
    { "place": 7, "name": "Chelsea 505", "score": 12005 },
    { "place": 8, "name": "Marcus M", "score": 10400 },
    { "place": 9, "name": "Blade United", "score": 9660 },
    { "place": 10, "name": "Lost Soul 1979", "score": 8700 },
    { "place": 11, "name": "One_Behind", "score": 7740 },
    { "place": 12, "name": "Brutal Truth 345", "score": 6220 },
    { "place": 13, "name": "Deformero", "score": 5550 },
    { "place": 14, "name": "Jason New_Kid", "score": 4110 }
  ]
}

=== 1.7 BalanceUpdated
Server sends this message periodically to notify client about real balance updates

[source,json]
.Response
{
  "class": "BalanceUpdated",
  "date": 1496748898812,
  "rid": -1,
  "balance": 1236600
}

=== 1.8 JoinBattleground
[source, json]
{
   "class": "JoinBattleground",
   "gameId": 808,
   "buyIn": 100,
   "date": 1496750162302,
   "rid": 1
}

gameId:: selected gameId
buyIn:: selected buyIn amount (in cents)

[source, json]
{
   "class": "JoinBattlegroundResponse",
   "startGameLink": "https://betsoft.com/launch.jsp?...",
   "date": 1496750162302,
   "rid": 1
}

startGameLink:: url for start game in battleground mode

=== 1.9 GetBattlegroundHistory
Request:
[source, json]
{
  "gameId": 821,
  "startDate": 2342342342,
  "endDate": 2342642342,
  "date": 1497154790288,
  "rid": 5,
  "class": "GetBattlegroundHistory
}

.Request parameters:
gameId:: gameId filter value, may be null
startDate:: start date period value, may be null. If not specified, equals to current datetime minus 24 hours.
endDate:: end date period value, may be null. If not specified, equals to current datetime
rid:: unique request id

Response:
[source, json]
{
  "date": 1497155412200,
  "rid": 1,
  "class": "GetBattlegroundHistoryResponse"
  "rounds":[
     {
         "gameId": 808,
         "gameName": "Dragon stone",
         "buyIn": 100,
         "roundId": 345345,
         "roomId": 234,
         "dateTime": 345345345645,
         "status": LIVE,
         "gameScore": 8345,
         "players": 4,
         "finalRank": null,
         "winnerName": null,
         "winnerPot": null
     },
     {
         "gameId": 821,
         "gameName": "Mission:Amazon",
         "buyIn": 1000,
         "roundId": 3453645,
         "roomId": 2346,
         "dateTime": 345345345645,
         "status": ENDED,
         "gameScore": 23423,
         "players": 2,
         "finalRank": 1,
         "winnerName": User123,
         "winnerPot": 1950
     },
     {
         "gameId": 808,
         "gameName": "Dragon stone",
         "buyIn": 1000,
         "roundId": 3456345,
         "roomId": 234,
         "dateTime": 345345345645,
         "status": CANCELED,
         "gameScore": null,
         "players": 4,
         "finalRank": null,
         "winnerName": null,
         "winnerPot": null
     }
  ]
}

.Where:
status:: battleground round status. May be: LIVE, ENDED, CANCELED
players:: players count
finalRank:: player final rank (1 for winner)
winnerName:: winner nickName
winner:: win amount


== 2. Error Codes
Error codes with id's below 1000 are fatal and could not be recovered on client side

|===
| Error code | Error name | Description

| 1
| INTERNAL_ERROR
| Unexpected error, please report it to BSG Server team

| 2
| SERVER_SHUTDOWN
|

| 3
| INVALID_SESSION
| Attempt to launch lobby with wrong session id

| 4
| FOUND_PENDING_OPERATION
| Player has pending operation, play is not possible

| 1001
| BAD_REQUEST
| Request is not recognized by server, check syntax or consult with Server Team

| 1002
| NOT_LOGGED_IN
| Client should perform EnterLobby first

| 1003
| NOT_ENOUGH_MONEY
| Player doesn't have enough money for BuyIn

| 1004
| TOURNAMENT_NOT_FOUND
| Requested tournament is not exist or not visible for this player

| 1005
| NOT_JOINED
| Attempt to get url for not joined tournament

| 1006
| TOURNAMENT_EXPIRED
| Cannot join tournament, already expired

|1007
| PLAYER_ALIAS_ALREADY_REGISTERED
| Cannot assign selected nickName, already taken
|===





