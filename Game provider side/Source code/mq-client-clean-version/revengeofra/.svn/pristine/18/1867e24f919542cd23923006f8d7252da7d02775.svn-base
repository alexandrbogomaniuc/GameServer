import Sprite from '../../../../../../../common/PIXI/src/display/Sprite';
import { APP } from '../../../../../../../common/PIXI/src/globals';
import { FRAME_RATE, WEAPONS } from '../../../../../../shared/src/CommonConstants';
import TextField from '../../../../../../../common/PIXI/src/display/TextField';
import NumberValueFormat from '../../../../../../../common/PIXI/src/view/custom/values/NumberValueFormat';
import PointerSprite from '../../../../../../../common/PIXI/src/display/ui/PointerSprite';
import I18 from '../../../../../../../common/PIXI/src/I18';
import WeaponSidebarIconEmblem from './WeaponSidebarIconEmblem';
import WeaponSidebarIconEmblemDefault from './WeaponSidebarIconEmblemDefault';
import Sequence from '../../../../../../../common/PIXI/src/animation/Sequence';
import * as Easing from '../../../../../../../common/PIXI/src/animation/easing';
import FreeShotsLabelView from './FreeShotsLabelView';

const STATE_FREE_SW = 0;
const STATE_PAID_SW = 1;
const STATE_BONUS = 2;

const STATES = [STATE_FREE_SW, STATE_PAID_SW, STATE_BONUS];

class WeaponSidebarIcon extends PointerSprite {

	static get EVENT_WEAPON_SIDEBAR_ICON_CLICKED () { return "EVENT_WEAPON_SIDEBAR_ICON_CLICKED"; }

	static get i_STATE_FREE_SW() 	{ return STATE_FREE_SW; }
	static get i_STATE_PAID_SW() 	{ return STATE_PAID_SW; }
	static get i_STATE_BONUS() 	{ return STATE_BONUS; }

	i_updatePrice(aPrice_num)
	{
		this._updatePrice(aPrice_num);
	}

	i_updateState(aNewState_int)
	{
		this._updateState(aNewState_int);
	}

	i_updateFreeShots(aFreeShots_int)
	{
		this._updateFreeShots(aFreeShots_int);
	}

	set freeShots(aVal_bln)
	{
		this._fFreeShots_bln = aVal_bln;

		this._invalidateView();
	}

	set isAnimating(aValue_bl)
	{
		this._fIsAnimating_bl = aValue_bl;
		if (this._fEmblem_wsie)
		{
			this._fEmblem_wsie.isAnimating = aValue_bl;
		}
	}

	get isAnimating()
	{
		return this._fIsAnimating_bl;
	}

	set active(aValue_bl)
	{
		if (this._fIsActive_bl != aValue_bl)
		{
			this._fIsActive_bl = aValue_bl;
			this._invalidateActiveState();
		}
	}

	get active()
	{
		return this._fIsActive_bl;
	}

	get weaponId()
	{
		return this._fWeaponId_int;
	}

	set isSelected(aValue_bl)
	{
		if (this._fIsSelected_bl != aValue_bl)
		{
			this._fIsSelected_bl = aValue_bl;
			this._invalidateView();
			this._checkSelectionAnimation();
		}
	}

	get isSelected()
	{
		return this._fIsSelected_bl;
	}

	get currentState()
	{
		return this._fCurrentState_int;
	}

	get price()
	{
		return this._fPrice_num;
	}

	get freeShots()
	{
		return this._fFreeShots_int;
	}

	constructor(aWeaponId_int) {
		super();

		this._fCurrentState_int = STATE_PAID_SW;
		this._fIsActive_bl = false;
		this._fIsSelected_bl = false;
		this._fIsAnimating_bl = false;

		this._fWeaponId_int = aWeaponId_int;
		this._fPrice_num = null;
		this._fFreeShots_int = null;

		this._fEmblem_wsie = null;
		this._fBackToDefaultEmblem_wsied = null;

		this._fPriceLabel_tf = null;
		this._fFreeShotsLabelView_fslv = null;
		this._fLabelTextFormat_obj = null;

		this._init();
	}

	_init()
	{
		this._initEmblem();
		this._initBackToDefaultEmblem();

		this._initButtonBehaviour();

		this._invalidateView();

	}

	_initButtonBehaviour()
	{
		//set cursor to default over the sidebar icon
		var cursorController = APP.currentWindow.cursorController;
		this.mouseover = () => cursorController.setOverRestrictedZone(true);
		this.mouseout = () => cursorController.setOverRestrictedZone(false);

		this.setHitArea(new PIXI.Circle(0, 0, 30));
		this.setEnabled();

		this.on("pointerdown", (e)=>e.stopPropagation(), this);
		this.on("pointerclick", this._onClicked, this);
	}

	_initEmblem()
	{
		this._fEmblem_wsie = this.addChild(new WeaponSidebarIconEmblem(this.weaponId));
		this._fEmblem_wsie.isAnimating = this.isAnimating;
	}

	_initBackToDefaultEmblem()
	{
		this._fBackToDefaultEmblem_wsied = this.addChild(new WeaponSidebarIconEmblemDefault());
	}

	//LABELS...
	_initPriceLabel()
	{
		this._fPriceLabel_tf = this.addChild(new TextField(this._labelTextFormat));
		this._fPriceLabel_tf.anchor.set(0.5, 0.5);
		this._fPriceLabel_tf.position.set(0, 20);
		this._fPriceLabel_tf.maxWidth = 70;

		return this._fPriceLabel_tf;
	}

	_initFreeShotsLabelView()
	{
		this._fFreeShotsLabelView_fslv = this.addChild(new FreeShotsLabelView());
		this._fFreeShotsLabelView_fslv.position.set(0, 20);
		return this._fFreeShotsLabelView_fslv;

	}

	get _freeShotsLabelView()
	{
		return this._fFreeShotsLabelView_fslv || this._initFreeShotsLabelView();
	}

	get _priceLabel()
	{
		return this._fPriceLabel_tf || this._initPriceLabel();
	}

	get _labelTextFormat()
	{
		return this._fLabelTextFormat_obj || this._initLabelTextFormat();
	}

	_initLabelTextFormat()
	{
		let l_ta = I18.generateNewCTranslatableAsset(this._freeShotsLabelViewTranslatableAssetName);
		this._fLabelTextFormat_obj = l_ta.textFormat;
		return this._fLabelTextFormat_obj;
	}

	get _freeShotsLabelViewTranslatableAssetName()
	{
		return "TAWeaponsSidebarIconFreeShotsLabel";
	}
	//...LABELS

	_updatePrice(aPrice_num)
	{
		this._fPrice_num = aPrice_num;
		let lCurrency_str = APP.playerController.info.currencySymbol || "";
		this._priceLabel.text = "\u200E" + lCurrency_str + "\u200E" + NumberValueFormat.formatMoney(aPrice_num);
	}

	_updateState(aNewState_int)
	{
		if (STATES.indexOf(aNewState_int) < 0)
		{
			throw new Error("Unsupported sidebar icon state: " + aNewState_int);
		}
		this._fCurrentState_int = aNewState_int;
		this._invalidateView();
	}

	_updateFreeShots(aFreeShots_int)
	{
		this._fFreeShots_int = aFreeShots_int;
		this._updateFreeShotsLabel(aFreeShots_int);
	}

	_updateFreeShotsLabel(aFreeShots_int)
	{
		let lIsAnimationNeeded_bl = this.isSelected;
		this._freeShotsLabelView.i_updateFreeShotsCount(aFreeShots_int, lIsAnimationNeeded_bl);
	}

	_invalidateView()
	{
		switch (this._fCurrentState_int)
		{
			case STATE_FREE_SW:
				this._fBackToDefaultEmblem_wsied.hide();
				this._fEmblem_wsie.visible = true;
				this._priceLabel.visible = false;

				this._freeShotsLabelView.show();
				break;
			case STATE_PAID_SW:
				this._freeShotsLabelView.hide();
				if (this.isSelected)
				{
					this._fBackToDefaultEmblem_wsied.show();
					this._fEmblem_wsie.visible = false;
				}
				else
				{
					this._fBackToDefaultEmblem_wsied.hide();
					this._fEmblem_wsie.visible = true;
				}
				this._priceLabel.visible = true;
				break;
			case STATE_BONUS:
				if (this.isSelected)
				{
					this._fBackToDefaultEmblem_wsied.show();
					this._fEmblem_wsie.visible = false;
					this._priceLabel.visible = false;
				}
				else
				{
					this._fBackToDefaultEmblem_wsied.hide();
					this._fEmblem_wsie.visible = true;
					this._priceLabel.visible = !this._fFreeShots_bln;
				}
				break;
		}

		this._invalidateActiveState();
		this._invalidateSelectionState();
	}

	_invalidateActiveState()
	{
		this._fEmblem_wsie.active = this.active;
	}

	_invalidateSelectionState()
	{
		this._fEmblem_wsie.isSelected = this.isSelected;
	}

	_onClicked()
	{
		if (!this.active) return;

		this.emit(WeaponSidebarIcon.EVENT_WEAPON_SIDEBAR_ICON_CLICKED, {weaponId: this.weaponId});
	}

	_checkSelectionAnimation()
	{
		this._resetAnimation();
		if (this.isSelected && this.isAnimating)
		{
			let selectionSeq = [
				{
					tweens: [
						{prop: "scale.x", to: 1.1},
						{prop: "scale.y", to: 1.1}
					],
					ease: Easing.sine.easeInOut,
					duration: 3 * FRAME_RATE
				},
				{
					tweens: [
						{prop: "scale.x", to: 1.148},
						{prop: "scale.y", to: 1.148}
					],
					ease: Easing.sine.easeInOut,
					duration: 3 * FRAME_RATE
				},
				{
					tweens: [
						{prop: "scale.x", to: 1},
						{prop: "scale.y", to: 1}
					],
					ease: Easing.sine.easeInOut,
					duration: 4 * FRAME_RATE
				},
				{
					tweens: [
						{prop: "scale.x", to: 0.973},
						{prop: "scale.y", to: 0.973}
					],
					ease: Easing.sine.easeInOut,
					duration: 3 * FRAME_RATE
				},
				{
					tweens: [
						{prop: "scale.x", to: 1},
						{prop: "scale.y", to: 1}
					],
					ease: Easing.sine.easeInOut,
					duration: 10 * FRAME_RATE
				}
			];
			Sequence.start(this, selectionSeq);
		}
	}

	_resetAnimation()
	{
		Sequence.destroy(Sequence.findByTarget(this));
		this.scale.set(1);
	}
}

export default WeaponSidebarIcon;