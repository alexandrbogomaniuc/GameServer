import SimpleUIView from '../../../../../../common/PIXI/src/view/base/SimpleUIView';
import { StringUtils } from '../../../../../../common/PIXI/src/Utils';
import { APP } from '../../../../../../common/PIXI/src/globals';
import TorchFxAnimation from '../../../main/animation/TorchFxAnimation';
import { Sprite } from '../../../../../../common/PIXI/src/display';

import Map4FXAnimation from './fx/Map4FXAnimation';
import Map5FXAnimation from './fx/Map5FXAnimation';
import Map6FXAnimation from './fx/Map6FXAnimation';

const MAP_SCALE = 1.026;
const MAPS_PATH_BACK = 'maps/#level#/back_#level#';
const MAPS_PATH_WALL = 'maps/#level#/wall_#level#_#index#';
const MAPS_DESCRIPTION = {
	"4":
	{
		"walls":
		{
			"0":
			{
				"x": 17,
				"y": 147 / 2 + 173.5 / 2,
				"zIndex": 492 / 2
			},
			"1":
			{
				"x": 121.5,
				"y": 95,
				"zIndex": 256 / 2
			},
			"2":
			{
				"x": 960 - 109 / 2 - 602 / 2,
				"y": 130 / 2,
				"zIndex": 229 / 2
			},
			"3":
			{
				"x": 960 - 142.5 / 2 - 290 / 2,
				"y": 540 - 49.5 / 2,
				"zIndex": 540
			},
			"4":
			{
				"x": 960 - 106.5 / 2 - 289 / 2,
				"y": 102,
				"zIndex": 378 / 2
			},
			"5":
			{
				"x": 960 - 117 / 2,
				"y": 145 / 2,
				"zIndex": 254 / 2
			},
		},
		fx: true
	},
	"5":
	{
		"walls":
		{
			"0":
			{
				"x": 0 / 2 + 60 / 2,
				"y": 0 / 2 + 249.5 / 2,
				"zIndex": 460 / 2
			},
			"1":
			{
				"x": 1370 / 2 + 275 / 2,
				"y": 0 / 2 + 246 / 2,
				"zIndex": 316 / 2
			},
			"2":
			{
				"x": 1703 / 2 + 108.5 / 2,
				"y": 664 / 2 + 191.5 / 2,
				"zIndex": 858 / 2
			}
		},
		"torches":
		{
			"0":
			{
				"x": (1573 - 0 ) / 2,
				"y": (239 - 37 * 0.65) / 2,
				"zIndex": 322 / 2,
				"scale": 0.65
			}
		},
		fx: true
	},
	"6":
	{
		"walls":
		{
			"0":
			{
				"x": 0 / 2 + 210 / 2,
				"y": 0 / 2 + 401.5 / 2,
				"zIndex": 550 / 2
			},
			"1":
			{
				"x": 1752 / 2 + 84 / 2,
				"y": 8 / 2 + 536 / 2,
				"zIndex": 2000 / 2
			}
		},
		"torches":
		{
			"0":
			{
				"x": 96 / 2,
				"y": (87 - 37) / 2,
				"zIndex": 550 / 2,
				"scale": 1.1
			},
			"1":
			{
				"x": (1375 - 0 ) / 2,
				"y": (141 - 37 * 0.65) / 2,
				"zIndex": 0 / 2,
				"scale": 0.65
			},
			"2":
			{
				"x": (1912 - 7) / 2,
				"y": (670 - 37) / 2,
				"zIndex": 2000 / 2,
				"scale": 1.1
			}
		},
		fx: true
	},
}

class MapsView extends SimpleUIView 
{
	constructor()
	{
		super();

		this._fMapId_int = undefined;

		this._fBack_sprt = undefined;
		this._fWalls_sprt_arr = [];
		this._fTorches_sprt_arr = [];
		this._fTintedObjects_sprt_arr = [];
	}

	//PUBLIC...

	/*draw or redraw map*/
	i_drawMap(aMapId_int)
	{
		this.i_destroyMap();
		
		this._fMapId_int = aMapId_int;

		let lMap_obj = MAPS_DESCRIPTION[this._fMapId_int];
		let lMapScale_num = MAP_SCALE;

		let lBackPath_str = StringUtils.replaceAll(MAPS_PATH_BACK, '#level#', this._fMapId_int);
		this._fBack_sprt = this._backContainer.addChild(APP.library.getSprite(lBackPath_str));
		let dx = this._fBack_sprt.width * (lMapScale_num - 1);
		let dy = this._fBack_sprt.height * (lMapScale_num - 1);
		this._fBack_sprt.scale.set(lMapScale_num);

		this._fTintedObjects_sprt_arr = this._fTintedObjects_sprt_arr || [];
		let lTintedBack_sprt = APP.library.getSprite('boss_mode/back_tinted');
		lTintedBack_sprt.scale.set(4);
		lTintedBack_sprt.alpha = 0;
		lTintedBack_sprt.visible = false;
		this._fTintedObjects_sprt_arr.push(lTintedBack_sprt);

		this._fWalls_sprt_arr = [];
		let lWallsNumber_int = Object.keys(lMap_obj.walls).length;

		for (let i=0; i<lWallsNumber_int; i++)
		{
			let lWall_obj = lMap_obj.walls[i];
			let lWallPath_str = StringUtils.replaceAll(MAPS_PATH_WALL, '#level#', this._fMapId_int);
			lWallPath_str = StringUtils.replaceAll(lWallPath_str, '#index#', i);
			
			let lWall_sprt = this._wallsContainer.addChild(APP.library.getSprite(lWallPath_str));
			lWall_sprt.position.set(lWall_obj.x * lMapScale_num - dx/2, lWall_obj.y * lMapScale_num - dy/2);
			lWall_sprt.zIndex = lWall_obj.zIndex * lMapScale_num;
			lWall_sprt.scale.set(lMapScale_num);
			this._fWalls_sprt_arr.push(lWall_sprt);

			let lTintedWall_sprt = lWall_sprt.clone();
			lTintedWall_sprt.tint = 0x000000;
			lTintedWall_sprt.alpha = 0;
			lTintedWall_sprt.visible = false;
			this._fTintedObjects_sprt_arr.push(this._wallsContainer.addChild(lTintedWall_sprt));
		}

		if (lMap_obj.torches)
		{
			TorchFxAnimation.initTextures();
			
			this._fTorches_sprt_arr = [];
			let lTorchesNumber_int = Object.keys(lMap_obj.torches).length;
			
			for (let i=0; i<lTorchesNumber_int; i++)
			{
				let lTorch_obj = lMap_obj.torches[i];
				let lTorch_sprt = this._torchesContainer.addChild(new Sprite);
				lTorch_sprt.textures = TorchFxAnimation.textures.torch;
				lTorch_sprt.zIndex = lTorch_obj.zIndex * lMapScale_num;
				lTorch_sprt.position.set(lTorch_obj.x * lMapScale_num - dx/2, lTorch_obj.y * lMapScale_num - dy/2);
				
				let torchScaleX = lTorch_obj.scaleX !== undefined ? lTorch_obj.scaleX : lTorch_obj.scale !== undefined ? lTorch_obj.scale : 1;
				let torchScaleY = lTorch_obj.scaleY !== undefined ? lTorch_obj.scaleY : lTorch_obj.scale !== undefined ? lTorch_obj.scale : 1;
				let torchRotation = lTorch_obj.rotation !== undefined ? lTorch_obj.rotation : 0;

				lTorch_sprt.scale.set(torchScaleX * lMapScale_num, torchScaleY * lMapScale_num);
				lTorch_sprt.rotation = torchRotation;
				lTorch_sprt.blendMode = PIXI.BLEND_MODES.ADD;
				lTorch_sprt.play();
				this._fTorches_sprt_arr.push(lTorch_sprt);
			}
		}

		if (lMap_obj.fx && APP.profilingController.info.isVfxProfileValueMediumOrGreater)
		{
			this._fMapFxAnimation_obj = this._getMapAnimationInstance();
			this._fMapFxAnimation_obj.startAnimation();
		}

		this._backContainer.addChild(lTintedBack_sprt);
		
		//DEBUG...
		// let polygon = this.uiInfo.currentMapWalkingZone;
		// let g = new PIXI.Graphics();
		// g.beginFill(0xff0000, 0.6);
		// console.log("[Y] DrawPolygon >> ", polygon);
		// g.drawPolygon(polygon);
		// g.drawRect(0, 0, 400, 500);
		// g.drawPolygon(0, 259, 286, 139, 593, 153);
		// g.endFill();
		// g.zIndex = 1000000;
		// g.position.set(-960/2, -540/2);
		// this._backContainer.addChild(g);
		//...DEBUG
	}

	_getMapAnimationInstance()
	{
		let lInstance_obj = null;
		switch(this._fMapId_int)
		{
			case 4:
				lInstance_obj = new Map4FXAnimation();
				break;
			case 5:
				lInstance_obj = new Map5FXAnimation();
				break;
			case 6:
				lInstance_obj = new Map6FXAnimation();
				break;
		}

		return lInstance_obj;
	}

	i_destroyMap()
	{
		this._fBack_sprt && this._fBack_sprt.destroy();
		this._fBack_sprt = null;

		while (this._fWalls_sprt_arr.length > 0)
		{
			this._fWalls_sprt_arr.pop().destroy();
		}
		this._fWalls_sprt_arr = null;

		while (this._fTorches_sprt_arr && this._fTorches_sprt_arr.length > 0)
		{
			this._fTorches_sprt_arr.pop().destroy();
		}
		this._fTorches_sprt_arr = null;

		while (this._fTintedObjects_sprt_arr.length > 0)
		{
			this._fTintedObjects_sprt_arr.pop().destroy();
		}
		this._fTintedObjects_sprt_arr = null;

		this._fMapFxAnimation_obj && this._fMapFxAnimation_obj.destroy();
		this._fMapFxAnimation_obj = null;
	}

	setTintedView(aVisible_bl, aDuration_int = 0)
	{
		let lTintedObjectsAmount_int = this._fTintedObjects_sprt_arr.length;
		for (var i = 0; i < lTintedObjectsAmount_int; i++)
		{
			let lAlpha_num = aVisible_bl ? (i > 0 ? 0.4 : 1) : 0;
			let lObject_sprt = this._fTintedObjects_sprt_arr[i];

			if (aDuration_int > 0)
			{
				if (aVisible_bl)
				{
					lObject_sprt.visible = true;
					lObject_sprt.fadeTo(lAlpha_num, aDuration_int);
				}
				else
				{
					lObject_sprt.fadeTo(lAlpha_num, aDuration_int, null, this.hideTintedObject.bind(this, lObject_sprt, i));
				}
			}
			else
			{
				lObject_sprt.visible = aVisible_bl;
				lObject_sprt.alpha = lAlpha_num;
			}
		}
	}

	hideTintedObject(aObject_sprt)
	{
		aObject_sprt.visible = false;
	}

	destroy()
	{
		this.i_destroyMap();

		this._fMapId_int = undefined;

		this._fBack_sprt = undefined;
		this._fDecorations_sprt_arr = null;
		this._fTintedObjects_sprt_arr = null;

		super.destroy();
	}
	//...PUBLIC

	//PRIVATE...
	get _backContainer ()
	{
		return APP.currentWindow.gameField.mapContainers.backContainer;
	}

	get _wallsContainer ()
	{
		return APP.currentWindow.gameField.mapContainers.wallsContainer;
	}

	get _torchesContainer ()
	{
		return APP.currentWindow.gameField.mapContainers.torchesContainer;
	}
	//...PRIVATE

}

export default MapsView;