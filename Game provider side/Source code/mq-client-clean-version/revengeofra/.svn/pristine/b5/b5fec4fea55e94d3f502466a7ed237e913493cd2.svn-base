import Sprite from '../../../../../../common/PIXI/src/display/Sprite';
import EternalPlazmaSmoke from './EternalPlazmaSmoke';
import InstantKillSpinner from './InstantKillSpinner';
import { Utils } from '../../../../../../common/PIXI/src/Utils';
import Sequence from '../../../../../../common/PIXI/src/animation/Sequence';
import Lightning from './Lightning';
import { Timer } from '../../../../../../common/PIXI/src/index';
import { APP } from '../../../../../../common/PIXI/src/globals';

const LIGHTNING_ROTATIONS = [-54, -107, -77];

class InstantKillAtomizer extends Sprite 
{
	static get EVENT_TIME_TO_SHOOT()						{return "onTimeToShoot";}
	static get EVENT_TIME_TO_SHOW_ALTERNATE_WEAPON_VIEW()	{return "onTimeToShowAlternateWeaponView";}

	constructor(aWeaponScale, aIsImmediateFire_bl = false)
	{
		super();

		this._fIsImmediateFire_bl = aIsImmediateFire_bl;
		this.plasmaSmoke = null;
		this.spinner = null;
		this.spinnerRepeatCounter = undefined;

		let delay = this._fIsImmediateFire_bl ? 150 : 200;
		this.timer = new Timer(this.createView.bind(this, aWeaponScale), delay);
	}

	createView(aWeaponScale)
	{
		this.timer.destructor();
		this.timer = null;
		this.emit(InstantKillAtomizer.EVENT_TIME_TO_SHOW_ALTERNATE_WEAPON_VIEW);
		if(APP.profilingController.info.isVfxProfileValueMediumOrGreater)
		{
			//indigo smoke...
			this.plasmaSmoke = this.addChild(new EternalPlazmaSmoke(true /*indigo style*/));
			this.plasmaSmoke.rotation = Utils.gradToRad(18.4);
			this.plasmaSmoke.scale.set();
			//...indigo smoke
			
			//common smokes...
			let smoke1 = new EternalPlazmaSmoke(true /*indigo style*/, "add");
			smoke1.scale.set(1.58*0.56, 2.36*0.56);
			this.addChild(smoke1);

			let smoke2 = new EternalPlazmaSmoke(true);
			smoke2.scale.set(2*0.594, 2*0.889);
			smoke2.rotation = Utils.gradToRad(11.7);
			smoke2.y = -30;
			this.addChild(smoke2);
			//...common smokes
		}
		
		//spinner...
		this.spinner = this.addChild(new InstantKillSpinner);
		this.spinner.y = -100;
		this.spinner.rotation = Utils.gradToRad(-20);
		this.spinner.scale.set(0);
		this.spinner.scaleYTo(0.774, 40*16.6);
		this.spinner.scaleXTo(0.545, 40*16.6);
		this.spinnerRepeatCounter = 0;
		
		if (this._fIsImmediateFire_bl)
		{
			this._onTimeToShoot();
			this.destroy();
			return;
		}
		
		//...spinner

		var sequence = [
			{	tweens: [],
				duration: 16*16.6,
				onfinish: () => {
					APP.profilingController.info.isVfxProfileValueMediumOrGreater && this.showLigntnings(aWeaponScale);
				}
			},
			{
				tweens: [],
				duration: 20*16.6,
				onfinish: () => {
					this._onTimeToShoot();
				}
			}
		]
		Sequence.start(this, sequence);
	}

	_onTimeToShoot()
	{
		this.emit(InstantKillAtomizer.EVENT_TIME_TO_SHOOT);
	}

	showLigntnings(aWeaponScale)
	{
		for (let i=0; i<3; i++)
		{
			let lightning = this.addChild(new Lightning());
			lightning.y = 10 - 60 * aWeaponScale; 
			lightning.scale.set(0.574);
			lightning.rotation = Utils.gradToRad(LIGHTNING_ROTATIONS[i]);
		}
	}

	destroy()
	{
		this.timer && this.timer.destructor();
		this.timer = null;

		Sequence.destroy(Sequence.findByTarget(this));
		
		this.plasmaSmoke = null;
		this.spinner = null;
		this.spinnerRepeatCounter = undefined;

		super.destroy();
	}
}

export default InstantKillAtomizer;